srcdir := @abs_top_srcdir@
builddir := @abs_top_builddir@
INSTALL_DIR := @prefix@

BINUTILS_SRCDIR := @with_binutils_src@
NEWLIB_SRCDIR := @with_newlib_src@
GCC_SRCDIR := @with_gcc_src@

all: stamps/build-gcc-stage2-win

clean-binutils-tc:
	rm -rf build-binutils-tc stamps/build-binutils-tc

clean-binutils-mcs:
	rm -rf build-binutils-mcs stamps/build-binutils-mcs

clean-gcc-stage1:
	rm -rf build-gcc-stage1 stamps/build-gcc-stage1

clean-newlib:
	rm -rf build-newlib stamps/build-newlib

clean-gcc-stage2:
	rm -rf build-gcc-stage2 stamps/build-gcc-stage2

clean-binutils-tc-win:
	rm -rf build-binutils-tc-win stamps/build-binutils-tc-win

clean-binutils-mcs-win:
	rm -rf build-binutils-mcs-win stamps/build-binutils-mcs-win

clean-gcc-stage2-win:
	rm -rf build-gcc-stage2-win stamps/build-gcc-stage2-win

clean:
	rm -rf build-* stamps

stamps/install-deps: $(GCC_SRCDIR)
	if test -f $</contrib/download_prerequisites && test "@NEED_GCC_EXTERNAL_LIBRARIES@" = "true"; then cd $< && ./contrib/download_prerequisites; fi
	mkdir -p $(dir $@) && touch $@

stamps/build-binutils-mcs: $(BINUTILS_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=mcs-elf \
		--program-prefix=mcs-elf- \
		--prefix=$(INSTALL_DIR)/linux \
		--disable-threads \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-binutils-tc: $(BINUTILS_SRCDIR) stamps/build-binutils-mcs
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--enable-targets=mcs-elf \
		--program-prefix=tricore-elf- \
		--prefix=$(INSTALL_DIR)/linux \
		--disable-threads \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-gcc-stage1: $(GCC_SRCDIR) stamps/install-deps stamps/build-binutils-tc
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		CFLAGS_FOR_TARGET='-g -O2 -gdwarf-3' \
		CXXFLAGS_FOR_TARGET='-g -O2 -gdwarf-3' \
		--target=tricore-elf \
		--prefix=$(INSTALL_DIR)/linux \
		--enable-lib32 \
		--disable-lib64 \
		--enable-languages=c,c++ \
		--enable-libstdcxx-debug-flags='-gdwarf-3 -g -O0 -D_GLIBCXX_ASSERTIONS' \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		--with-headers=yes \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--disable-libstdcxx-pch \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite
	$(MAKE) -C $(notdir $@) all-gcc
	$(MAKE) -C $(notdir $@) install-gcc
	mkdir -p $(dir $@) && touch $@

stamps/build-newlib: $(NEWLIB_SRCDIR) stamps/build-gcc-stage1
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		CC_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-gcc \
		CXX_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-c++ \
		GCC_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-gcc \
		AR_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-ar \
		AS_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-as \
		LD_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-ld \
		NM_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-nm \
		OBJDUMP_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-objdump \
		RANLIB_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-ranlib \
		STRIP_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-strip \
		READELF_FOR_TARGET=$(INSTALL_DIR)/linux/bin/tricore-elf-readelf \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffunction-sections -mfast-div -fno-common' \
		CXXFLAGS_FOR_TARGET='-g -gdwarf-3 -O2  -ffunction-sections -mfast-div -fno-common' \
		--target=tricore-elf \
		--prefix=$(INSTALL_DIR)/linux \
		--host=i686-w64-mingw32 \
		--build=i686-pc-mingw32
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	$(MAKE) -C $(notdir $@) install prefix=$(INSTALL_DIR)/win32
	mkdir -p $(dir $@) && touch $@

stamps/build-gcc-stage2: $(GCC_SRCDIR) stamps/install-deps stamps/build-newlib
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CPPFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		--target=tricore-elf \
		--enable-lib32 \
		--disable-lib64 \
		--prefix=$(INSTALL_DIR)/linux \
		--enable-languages=c,c++ \
		--enable-libstdcxx-debug-flags='-gdwarf-3 -g -O0 -D_GLIBCXX_ASSERTIONS' \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		--with-headers=yes \
		--with-gnu-ld \
		--with-gnu-as \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--disable-libstdcxx-pch \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-binutils-mcs-win: $(BINUTILS_SRCDIR) stamps/build-gcc-stage2
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=mcs-elf \
		--program-prefix=mcs-elf- \
		--host=x86_64-w64-mingw32 \
		--prefix=$(INSTALL_DIR)/win32 \
		--disable-threads \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-binutils-tc-win: $(BINUTILS_SRCDIR) stamps/build-binutils-mcs-win
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--enable-targets=mcs-elf \
		--program-prefix=tricore-elf- \
		--host=x86_64-w64-mingw32 \
		--prefix=$(INSTALL_DIR)/win32 \
		--disable-threads \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@
	
stamps/build-gcc-stage2-win: $(GCC_SRCDIR) stamps/install-deps stamps/build-binutils-tc-win
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && PATH=$(INSTALL_DIR)/linux/bin:$$PATH $</configure \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CPPFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		--target=tricore-elf \
		--enable-lib32 \
		--disable-lib64 \
		--host=x86_64-w64-mingw32 \
		--prefix=$(INSTALL_DIR)/win32 \
		--enable-languages=c,c++ \
		--enable-libstdcxx-debug-flags='-gdwarf-3 -g -O0 -D_GLIBCXX_ASSERTIONS' \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		--with-headers=yes \
		--with-gnu-ld \
		--with-gnu-as \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--disable-libstdcxx-pch \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@