srcdir := @abs_top_srcdir@
builddir := @abs_top_builddir@
INSTALL_DIR := @prefix@

BINUTILS_SRCDIR := @with_binutils_src@
NEWLIB_SRCDIR := @with_newlib_src@
GCC_SRCDIR := @with_gcc_src@
QEMU_SRCDIR := $(srcdir)/qemu

CONFIGURE_LIBSTDCXX = @configure_libstdcxx@
CONFIGURE_HOST = @configure_host@
QEMU_CONFIGURE_HOST = @qemu_configure_host@

ifeq ($(CONFIGURE_HOST),--host=x86_64-w64-mingw32)
	NCURSES_FLAGS := --disable-home-terminfo --disable-termcap --without-libtool --enable-term-driver --enable-exp-win32 --enable-ext-funcs
else
	NCURSES_FLAGS :=
endif

ifeq ($(QEMU_CONFIGURE_HOST),--cross-prefix=x86_64-w64-mingw32-)
	QEMU_ENV_VARS := PKG_CONFIG_PATH="$(INSTALL_DIR)/lib/pkgconfig" PKG_CONFIG_LIBDIR="$(INSTALL_DIR)/lib/pkgconfig"
else
	QEMU_ENV_VARS :=
endif

all: stamps/build-qemu stamps/build-gcc-stage2

clean-binutils-tc:
	rm -rf build-binutils-tc stamps/build-binutils-tc

clean-binutils-mcs:
	rm -rf build-binutils-mcs stamps/build-binutils-mcs

clean-gcc-stage1:
	rm -rf build-gcc-stage1 stamps/build-gcc-stage1

clean-newlib:
	rm -rf build-newlib stamps/build-newlib

clean-gcc-stage2:
	rm -rf build-gcc-stage2 stamps/build-gcc-stage2

clean-gcc-stage2-only:
	rm -rf build-gcc-stage2-only stamps/build-gcc-stage2-only

clean-qemu:
	rm -rf build-qemu stamps/build-qemu

clean:
	rm -rf build-* stamps

stamps/build-binutils-mcs: $(BINUTILS_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=mcs-elf \
		--program-prefix=mcs-elf- \
		--prefix=$(INSTALL_DIR) \
		$(CONFIGURE_HOST) \
		--enable-static \
		--disable-shared \
		--disable-threads \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) MAKEINFO=true
	$(MAKE) -C $(notdir $@) MAKEINFO=true install
	mkdir -p $(dir $@) && touch $@

stamps/build-binutils-tc: $(BINUTILS_SRCDIR) stamps/build-binutils-mcs
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--enable-targets=mcs-elf \
		--program-prefix=tricore-elf- \
		--prefix=$(INSTALL_DIR) \
		$(CONFIGURE_HOST) \
		--enable-static \
		--disable-shared \
		--disable-threads \
		--with-static-standard-libraries \
		--enable-nls \
		--disable-itcl \
		--disable-tk \
		--disable-tcl \
		--disable-winsup \
		--disable-gdbtk \
		--disable-libgui \
		--disable-rda \
		--disable-sid \
		--disable-sim \
		--disable-gdb \
		--disable-newlib \
		--disable-libgloss \
		--disable-test-suite \
		--enable-checking=release \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-werror \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) MAKEINFO=true
	$(MAKE) -C $(notdir $@) MAKEINFO=true install
	mkdir -p $(dir $@) && touch $@

stamps/build-gcc-stage1: $(GCC_SRCDIR) stamps/build-binutils-tc
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--prefix=$(INSTALL_DIR) \
		--enable-lib32 \
		--disable-lib64 \
		--enable-languages=c,c++ \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		$(CONFIGURE_LIBSTDCXX) \
		--with-headers=yes \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite \
		CFLAGS_FOR_TARGET='-g -O2 -gdwarf-3' \
		CXXFLAGS_FOR_TARGET='-g -O2 -gdwarf-3' \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) all-gcc
	$(MAKE) -C $(notdir $@) install-gcc
	mkdir -p $(dir $@) && touch $@

stamps/build-newlib: $(NEWLIB_SRCDIR) stamps/build-gcc-stage1
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		CC_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-gcc \
		CXX_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-c++ \
		GCC_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-gcc \
		AR_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-ar \
		AS_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-as \
		LD_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-ld \
		NM_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-nm \
		OBJDUMP_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-objdump \
		RANLIB_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-ranlib \
		STRIP_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-strip \
		READELF_FOR_TARGET=$(INSTALL_DIR)/bin/tricore-elf-readelf \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffunction-sections -mfast-div -fno-common' \
		CXXFLAGS_FOR_TARGET='-g -gdwarf-3 -O2  -ffunction-sections -mfast-div -fno-common' \
		--target=tricore-elf \
		--prefix=$(INSTALL_DIR) \
		--host=i686-w64-mingw32 \
		--build=i686-pc-mingw32
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-gcc-stage2: $(GCC_SRCDIR) stamps/build-newlib
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && PATH=$(INSTALL_DIR)/bin:$$PATH $</configure \
		--target=tricore-elf \
		--enable-lib32 \
		--disable-lib64 \
		--prefix=$(INSTALL_DIR) \
		$(CONFIGURE_HOST) \
		--enable-languages=c,c++ \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		$(CONFIGURE_LIBSTDCXX) \
		--with-headers=yes \
		--with-gnu-ld \
		--with-gnu-as \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CXXFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-gcc-stage2-only: $(GCC_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--enable-lib32 \
		--disable-lib64 \
		--prefix=$(INSTALL_DIR) \
		$(CONFIGURE_HOST) \
		--enable-languages=c,c++ \
		--enable-c99 \
		--enable-long-long \
		--enable-checking \
		--enable-nls \
		--enable-static \
		--disable-threads \
		--disable-shared \
		$(CONFIGURE_LIBSTDCXX) \
		--with-headers=yes \
		--with-gnu-ld \
		--with-gnu-as \
		--with-newlib=yes \
		--enable-mingw-wildcard \
		--enable-newlib-elix-level=3 \
		--enable-newlib-io-long-long \
		--disable-newlib-supplied-syscalls \
		--disable-libssp \
		--disable-test-suite \
		CFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CXXFLAGS_FOR_TARGET='-g -gdwarf-3 -O2 -ffast-math -ffunction-sections -mfast-div -fno-common -mno-eabi-bitfield-limit' \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-qemu: $(QEMU_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	if test "$(QEMU_CONFIGURE_HOST)" = "--cross-prefix=x86_64-w64-mingw32-"; then cd $(notdir $@) && $(srcdir)/scripts/build-mingw32-deps $(INSTALL_DIR); fi
	cd $(notdir $@) && $(QEMU_ENV_VARS) $</configure \
		--prefix=$(INSTALL_DIR) \
		$(QEMU_CONFIGURE_HOST) \
		--target-list=tricore-softmmu \
		--bindir=bin \
		--datadir=share/qemu \
		--localedir=share/locale \
		--static \
		--without-default-features \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@) all
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-ncurses: $(NCURSES_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--prefix=$(INSTALL_DIR)/deps \
		$(CONFIGURE_HOST) \
		--enable-static \
		--disable-shared \
		--enable-widec \
		$(NCURSES_FLAGS) \
		--without-ada \
		--without-progs \
		--without-manpages \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@

stamps/build-gdb: $(BINUTILS_SRCDIR)
	rm -rf $@ $(notdir $@)
	mkdir $(notdir $@)
	cd $(notdir $@) && $</configure \
		--target=tricore-elf \
		--enable-targets=mcs-elf \
		--program-prefix=tricore-elf- \
		--prefix=$(INSTALL_DIR) \
		$(CONFIGURE_HOST) \
		--enable-static \
		--disable-shared \
		--disable-threads \
		--with-static-standard-libraries \
		--with-libexpat-type=static \
		--disable-nls \
		--disable-werror \
		--disable-gdbtk \
		--disable-libgui \
		--disable-gas \
		--disable-binutils \
		--disable-ld \
		--disable-gold \
		--disable-gprof \
		--enable-gdb \
		--enable-tui \
		--without-guile \
		--without-debuginfod \
		--with-gnu-ld \
		--with-gnu-as \
		--disable-unit-tests \
		CFLAGS="-O2" \
		CXXFLAGS="-O2" \
		LDFLAGS="-s"
	$(MAKE) -C $(notdir $@)
	$(MAKE) -C $(notdir $@) install
	mkdir -p $(dir $@) && touch $@